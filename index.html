<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>電子書籍ビューア</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #111827;
      --panel-bg: #111827;
      --accent: #3b82f6;
      --accent-soft: #1f2937;
      --fg: #e5e7eb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --zoom: 1;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #1f2937, #020617);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .viewer-shell {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(15, 23, 42, 0.96);
      backdrop-filter: blur(12px);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.6);
      border-radius: 16px;
      overflow: hidden;
    }

    header.viewer-header {
      padding: 10px 16px;
      border-bottom: 1px solid #1f2937;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }

    .viewer-title-main {
      font-size: 16px;
      font-weight: 600;
      color: #e5e7eb;
    }

    .viewer-title-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .viewer-page-info {
      margin-left: auto;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    main.viewer-main {
      flex: 1;
      background: radial-gradient(circle at top, #020617, #020617 40%, #000 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 8px;
      overflow: hidden;
    }

    .page-wrapper-outer {
      position: relative;
      max-width: 100%;
      max-height: 100%;
      overflow: auto;
      padding: 8px;
    }

    .page-wrapper-inner {
      display: flex;
      gap: 8px;
      transform-origin: top center;
      transform: scale(var(--zoom));
      transition: transform 0.15s ease-out;
      justify-content: center;
      align-items: flex-start;
      flex-direction: row-reverse;
    }

    .page-frame {
      background: #020617;
      border-radius: 4px;
      box-shadow: 0 0 0 1px #1e293b, 0 16px 40px rgba(0, 0, 0, 0.8);
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
  /* ★ ここを追加／変更：常に左右が半々になるようにする */
  flex: 1 1 0;
  min-width: 0;
      max-height: calc(100vh - 180px);
    }

    .page-image {
      display: block;
      width: 100%;
      height: auto;
      background: #020617;
    }

    footer.viewer-controls {
      padding: 8px 12px 10px;
      border-top: 1px solid #1f2937;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .control-group {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #020617;
      border-radius: 999px;
      padding: 4px;
    }

    .control-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      padding: 0 6px;
    }

    button.ctrl-btn {
      border: none;
      outline: none;
      padding: 4px 10px;
      border-radius: 999px;
      background: #0b1120;
      color: var(--fg);
      cursor: pointer;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      min-width: 0;
      transition: background 0.15s ease, transform 0.05s ease;
    }

    button.ctrl-btn span.icon {
      font-size: 13px;
      line-height: 1;
    }

    button.ctrl-btn:hover {
      background: #111827;
    }

    button.ctrl-btn:active {
      transform: translateY(1px);
    }

    button.ctrl-btn.primary {
      background: var(--accent);
    }

    button.ctrl-btn.primary:hover {
      background: #2563eb;
    }

    button.ctrl-btn.danger {
      background: #7f1d1d;
    }

    .zoom-display {
      font-variant-numeric: tabular-nums;
      font-size: 12px;
      color: var(--muted);
      min-width: 54px;
      text-align: center;
    }

    .page-jump-input {
      width: 60px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: var(--fg);
      font-size: 12px;
      text-align: center;
      outline: none;
    }

    .page-jump-input:focus {
      border-color: var(--accent);
    }

    .badge-mode {
      margin-left: auto;
      font-size: 11px;
      color: var(--muted);
      background: #020617;
      border-radius: 999px;
      padding: 4px 10px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }

    @media (max-width: 768px) {
      .viewer-shell {
        border-radius: 0;
        box-shadow: none;
      }
      header.viewer-header {
        padding: 8px 10px;
      }
      main.viewer-main {
        padding: 4px;
      }
      footer.viewer-controls {
        padding: 6px 8px 8px;
      }
      .viewer-title-main {
        font-size: 14px;
      }
      .viewer-page-info {
        font-size: 11px;
      }
    }

/* 画面端の縦長ナビボタン */
.page-nav-overlay {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 26px;          /* ★ 40px → 26px に細くした */
  height: 60%;
  border: none;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.65);
  color: #e5e7eb;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;      /* 少しだけ小さく */
  cursor: pointer;
  z-index: 30;
  box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.8),
              0 8px 24px rgba(0,0,0,0.7);
  transition: background 0.15s ease, opacity 0.15s ease, transform 0.1s ease;
  opacity: 0;
  pointer-events: none;
}

.page-nav-overlay.show {
  opacity: 1;
  pointer-events: auto;
}

.page-nav-prev {
  left: 8px;
}

.page-nav-next {
  right: 8px;
}

.page-nav-overlay:hover {
  background: rgba(37, 99, 235, 0.85);
  transform: translateY(-50%) scale(1.03);
}


    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      margin: -1px;
      padding: 0;
      border: 0;
      clip: rect(0 0 0 0);
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div class="viewer-shell">
    <header class="viewer-header">
      <div>
        <div class="viewer-title-main" id="viewerTitleMain">最新号ビューア</div>
        <div class="viewer-title-sub" id="viewerTitleSub"></div>
      </div>
      <div class="viewer-page-info" id="viewerPageInfo">
        Page ? / ?
      </div>
    </header>

    <main class="viewer-main">
      <div class="page-wrapper-outer">
        <div class="page-wrapper-inner" id="pageWrapper" aria-live="polite">
          <!-- ページ画像がここに差し込まれる -->
        </div>
      </div>
    </main>

    <footer class="viewer-controls">
      <div class="control-group" aria-label="ページ移動">
        <span class="control-label">PAGE</span>
        <button class="ctrl-btn" id="prevBtn" type="button">
          <span class="icon">⟵</span><span>前へ</span>
        </button>
        <button class="ctrl-btn primary" id="nextBtn" type="button">
          <span>次へ</span><span class="icon">⟶</span>
        </button>
        <input
          type="number"
          min="1"
          id="pageJumpInput"
          class="page-jump-input"
          title="ページ番号を入力して移動"
        />
      </div>

      <div class="control-group" aria-label="ズーム">
        <span class="control-label">ZOOM</span>
        <button class="ctrl-btn" id="zoomOutBtn" type="button">
          <span class="icon">−</span>
        </button>
        <div class="zoom-display" id="zoomDisplay">100%</div>
        <button class="ctrl-btn" id="zoomInBtn" type="button">
          <span class="icon">＋</span>
        </button>
        <button class="ctrl-btn" id="zoomResetBtn" type="button">
          リセット
        </button>
      </div>

      <div class="badge-mode" id="modeBadge">
        <span class="badge-dot"></span>
        <span id="modeBadgeText">1ページ表示</span>
      </div>
    </footer>
  </div>

  <script>
    // ============================
    // 号ごとの設定
    // ============================
    // ★ とりあえず「1つの号」の設定をここにベタ書きしておいて、
    //   後で /config/*.json から読み込む形に差し替え予定。
    const ISSUE_CONFIG = {
  // 画面左上のタイトル表示（お好みで変更OK）
  title: "第2169号",
  subtitle: "2025年12月8日号",

  // 合計ページ数（実際の枚数に合わせて調整）
  totalPages: 24,

  // 画像ファイル格納パス（issues/weekly/2169/001.webp など）
  // ※ここは「先頭スラッシュなし」「末尾スラッシュなし」にしておく
  basePath: "issues/weekly/2169",

  // ファイル名のパターン
  // {num} → 001, 002, 003 ... の部分
  filePattern: "{num}.webp",

  // ゼロ埋め桁数（001, 002 ... なら 3）
  zeroPad: 3,

  // 初期ページ
  startPage: 1
};


    // ============================
    // 状態管理
    // ============================
    let currentPage = ISSUE_CONFIG.startPage || 1;
    let zoom = 1.0;

    const MIN_ZOOM = 0.5;
    const MAX_ZOOM = 2.0;
    const ZOOM_STEP = 0.1;

    const pageWrapper = document.getElementById("pageWrapper");
    const pageWrapperOuter = document.querySelector(".page-wrapper-outer");
    const viewerTitleMain = document.getElementById("viewerTitleMain");
    const viewerTitleSub = document.getElementById("viewerTitleSub");
    const viewerPageInfo = document.getElementById("viewerPageInfo");
    const zoomDisplay = document.getElementById("zoomDisplay");
    const modeBadgeText = document.getElementById("modeBadgeText");
    const pageJumpInput = document.getElementById("pageJumpInput");

    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const zoomInBtn = document.getElementById("zoomInBtn");
    const zoomOutBtn = document.getElementById("zoomOutBtn");
    const zoomResetBtn = document.getElementById("zoomResetBtn");



// ナビボタン用の状態
let navButtonsVisible = false;

// ナビボタンDOMを作成
const navPrevOverlay = document.createElement("button");
navPrevOverlay.type = "button";
navPrevOverlay.className = "page-nav-overlay page-nav-prev";
navPrevOverlay.innerHTML = "◀";

const navNextOverlay = document.createElement("button");
navNextOverlay.type = "button";
navNextOverlay.className = "page-nav-overlay page-nav-next";
navNextOverlay.innerHTML = "▶";



// outer に乗せる
if (pageWrapperOuter) {
  pageWrapperOuter.appendChild(navPrevOverlay);
  pageWrapperOuter.appendChild(navNextOverlay);
}



let navHideTimer = null;

function scheduleHideNavButtons(ms = 4000) {
  if (navHideTimer) {
    clearTimeout(navHideTimer);
  }
  navHideTimer = setTimeout(() => {
    hideNavButtons();
  }, ms);
}

function showNavButtons() {
  if (!pageWrapperOuter) return;
  navButtonsVisible = true;
  navPrevOverlay.classList.add("show");
  navNextOverlay.classList.add("show");
  scheduleHideNavButtons();   // ★ 表示したら自動で消えるタイマー起動
}

function hideNavButtons() {
  navButtonsVisible = false;
  navPrevOverlay.classList.remove("show");
  navNextOverlay.classList.remove("show");
  if (navHideTimer) {
    clearTimeout(navHideTimer);
    navHideTimer = null;
  }
}


    // ============================
    // ユーティリティ
    // ============================
    function pad(num, size) {
      let s = String(num);
      while (s.length < size) s = "0" + s;
      return s;
    }

    function getPageUrl(pageNum) {
      const nn = pad(pageNum, ISSUE_CONFIG.zeroPad);
      return (
        ISSUE_CONFIG.basePath +
        "/" +
        ISSUE_CONFIG.filePattern.replace("{num}", nn)
      );
    }

    function isDoublePageMode() {
      // 画面幅が広いときは見開きモード
      return window.innerWidth >= 900;
    }

    function clampPage(p) {
      if (p < 1) return 1;
      if (p > ISSUE_CONFIG.totalPages) return ISSUE_CONFIG.totalPages;
      return p;
    }

    function setZoom(z) {
      zoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, z));
      document.documentElement.style.setProperty("--zoom", zoom);
      zoomDisplay.textContent = Math.round(zoom * 100) + "%";
    }

// ============================
// 描画処理
// ============================
function renderViewer() {
  // ヘッダ表示
  viewerTitleMain.textContent = ISSUE_CONFIG.title || "電子書籍ビューア";
  viewerTitleSub.textContent = ISSUE_CONFIG.subtitle || "";
  viewerPageInfo.textContent =
    "Page " + currentPage + " / " + ISSUE_CONFIG.totalPages;

  // ページ入力の初期値
  pageJumpInput.value = String(currentPage);

  const doubleMode  = isDoublePageMode();
  const isCover     = (currentPage === 1);
  const isBackCover = (currentPage === ISSUE_CONFIG.totalPages);

  const total = ISSUE_CONFIG.totalPages;

  // モード表示バッジ
  modeBadgeText.textContent = doubleMode ? "2ページ見開き" : "1ページ表示";

  // 中身作り直し
  pageWrapper.innerHTML = "";
  const inner = document.createElement("div");
  inner.className = "page-wrapper-inner";

  if (!doubleMode) {
    // ▽ 単ページモード：常に1ページだけセンター表示
    const frame = document.createElement("div");
    frame.className = "page-frame";

    const img = document.createElement("img");
    img.className = "page-image";
    img.alt = "Page " + currentPage;
    img.src = getPageUrl(currentPage);

    frame.appendChild(img);
    inner.appendChild(frame);
  } else {
    // ▽ 見開きモード：左／右フレームを用意
    const frameLeft  = document.createElement("div");
    const frameRight = document.createElement("div");
    frameLeft.className  = "page-frame";
    frameRight.className = "page-frame";

    if (isCover) {
      // ★ 表紙 → 右ページだけ表示（左は空白）
      const imgRight = document.createElement("img");
      imgRight.className = "page-image";
      imgRight.alt = "Page 1";
      imgRight.src = getPageUrl(1);
      frameRight.appendChild(imgRight);

      // frameLeft は何も入れない（白紙）
    } else if (isBackCover) {
      // ★ 裏表紙 → 左ページだけ表示（右は空白）
      const imgLeft = document.createElement("img");
      imgLeft.className = "page-image";
      imgLeft.alt = "Page " + total;
      imgLeft.src = getPageUrl(total);
      frameLeft.appendChild(imgLeft);

      // frameRight は何も入れない（白紙）
    } else {
      // ★ 通常：currentPage / currentPage+1 を左右に
      const imgLeft = document.createElement("img");
      imgLeft.className = "page-image";
      imgLeft.alt = "Page " + currentPage;
      imgLeft.src = getPageUrl(currentPage);
      frameLeft.appendChild(imgLeft);

      const nextPage = currentPage + 1;
      if (nextPage <= total) {
        const imgRight = document.createElement("img");
        imgRight.className = "page-image";
        imgRight.alt = "Page " + nextPage;
        imgRight.src = getPageUrl(nextPage);
        frameRight.appendChild(imgRight);
      }
    }

    // flex の並び順どおり「左→右」で append
    inner.appendChild(frameLeft);
    inner.appendChild(frameRight);
  }

  pageWrapper.appendChild(inner);
}


    // ============================
    // ページ移動
    // ============================
    function goToPage(p) {
      currentPage = clampPage(p);
      renderViewer();
    }

function goNext() {
  const doubleMode = isDoublePageMode();

  // 見開きでも、表紙(1)の次だけは 2 を飛ばさない
  if (doubleMode && currentPage === 1) {
    goToPage(2);
    return;
  }

  const step = doubleMode ? 2 : 1;
  goToPage(currentPage + step);
}

function goPrev() {
  const doubleMode = isDoublePageMode();

  // 見開きで「2&3」を表示中（currentPage=2）から戻る時は +1 戻しで表紙へ
  if (doubleMode && currentPage === 2) {
    goToPage(1);
    return;
  }

  const step = doubleMode ? 2 : 1;
  goToPage(currentPage - step);
}

// 末尾が裏表紙（totalPages）の1つ手前なら +1 で最後へ
if (doubleMode && currentPage === ISSUE_CONFIG.totalPages - 1) {
  goToPage(ISSUE_CONFIG.totalPages);
  return;
}

    // ============================
    // イベントハンドラ
    // ============================
    // ★ 縦書き右→左用：左側の「前へ」ボタンでページを進める
prevBtn.addEventListener("click", () => {
  goPrev();  // ラベルは「前へ」だけど、ページ番号は進む
});

// ★ 右側の「次へ」ボタンでページを戻る
nextBtn.addEventListener("click", () => {
  goNext();
});


// 三角オーバーレイ側のクリックでページ移動
// ★ 左側（prevクラス）＝「次へ」：縦書きなので右→左に進むイメージ
navPrevOverlay.addEventListener("click", (e) => {
  e.stopPropagation();
  goNext();              // ← ここを goNext に
  scheduleHideNavButtons();
});

// ★ 右側（nextクラス）＝「前へ」に戻る
navNextOverlay.addEventListener("click", (e) => {
  e.stopPropagation();
  goPrev();              // ← ここを goPrev に
  scheduleHideNavButtons();
});



    zoomInBtn.addEventListener("click", () => {
      setZoom(zoom + ZOOM_STEP);
    });

    zoomOutBtn.addEventListener("click", () => {
      setZoom(zoom - ZOOM_STEP);
    });

    zoomResetBtn.addEventListener("click", () => {
      setZoom(1.0);
    });

    pageJumpInput.addEventListener("change", () => {
      const v = parseInt(pageJumpInput.value, 10);
      if (!isNaN(v)) {
        goToPage(v);
      }
    });

    // キーボード操作
    window.addEventListener("keydown", (e) => {
      if (e.defaultPrevented) return;
      switch (e.key) {
        case "ArrowRight":
        case "PageDown":
          e.preventDefault();
          goNext();
          break;
        case "ArrowLeft":
        case "PageUp":
          e.preventDefault();
          goPrev();
          break;
        case "+":
        case "=":
          setZoom(zoom + ZOOM_STEP);
          break;
        case "-":
        case "_":
          setZoom(zoom - ZOOM_STEP);
          break;
        case "0":
          setZoom(1.0);
          break;
      }
    });

    // ウィンドウサイズ変更時：1ページ/2ページ切り替え
    window.addEventListener("resize", () => {
      renderViewer();
    });

    // 簡易スワイプ対応（スマホ向け）
    (function setupSwipe() {
      let touchStartX = null;
      let touchStartY = null;

      pageWrapper.addEventListener(
        "touchstart",
        (e) => {
          const t = e.touches[0];
          touchStartX = t.clientX;
          touchStartY = t.clientY;
        },
        { passive: true }
      );

      pageWrapper.addEventListener(
        "touchend",
        (e) => {
          if (touchStartX == null || touchStartY == null) return;
          const t = e.changedTouches[0];
          const dx = t.clientX - touchStartX;
          const dy = t.clientY - touchStartY;

          // 横方向のスワイプが大きいときだけ
          if (Math.abs(dx) > 40 && Math.abs(dx) > Math.abs(dy) * 1.5) {
            if (dx < 0) {
              goNext();
            } else {
              goPrev();
            }
          }

          touchStartX = null;
          touchStartY = null;
        },
        { passive: true }
      );
    })();


if (pageWrapperOuter) {
  pageWrapperOuter.addEventListener("click", (e) => {
    const rect = pageWrapperOuter.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const w = rect.width;

    // 1ページ分の1/20 を「端領域」として使う
    const edgeWidth = w / 20;

    // すでにボタンが出ている状態でのクリック
    if (navButtonsVisible) {
      // 三角ボタン以外をクリック → ボタンを消すだけ
      if (!e.target.closest(".page-nav-overlay")) {
        hideNavButtons();
      }
      return;
    }

    // まだボタンが出ていない状態：
    // 左端 or 右端の狭い範囲をクリックしたら、ボタンを出す
    const isLeftEdge  = (x <= edgeWidth);
    const isRightEdge = (x >= w - edgeWidth);

    if (isLeftEdge || isRightEdge) {
      showNavButtons();
      // 1回目のクリックではページ移動しない
      e.preventDefault();
      e.stopPropagation();
    }
  });
}


    // ============================
    // 初期化
    // ============================
    function initFromQuery() {
      // 将来的には ?issue=xxx や ?page=10 などをここで読む予定
      const params = new URLSearchParams(window.location.search);
      const pageParam = parseInt(params.get("page") || "", 10);
      if (!isNaN(pageParam)) {
        currentPage = clampPage(pageParam);
      }

      setZoom(1.0);
      renderViewer();
    }

    window.addEventListener("load", initFromQuery);
  </script>
</body>
</html>
